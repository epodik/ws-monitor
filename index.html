<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>WS Monitor ‚Äî Crypto & Forex</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{background:#0e1117;color:#e0e0e0;font-family:'Courier New',monospace;padding:20px;margin:0}
    h2{color:#66fcf1;margin-bottom:10px}
    .section{margin-bottom:40px;border:1px solid #222;border-radius:10px;padding:15px;background:#1b1f27}
    .section h3{color:#45a29e;margin-bottom:10px}
    table{border-collapse:collapse;width:100%;background:#101318;border-radius:8px;overflow:hidden;margin-bottom:10px}
    th,td{padding:8px;text-align:left}
    th{background:#222831;color:#66fcf1}
    tr:nth-child(even){background:#161a20}
    .up{color:#00ff88}
    .down{color:#ff5555}
    .last-list{list-style:none;padding:0;margin:0;max-height:260px;overflow-y:auto;border:1px solid #333;border-radius:8px}
    .tick{display:flex;justify-content:space-between;padding:6px 10px;border-bottom:1px dashed #2a2f3a;font-size:14px}
    .tick:last-child{border-bottom:none}
    .controls{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:10px}
    input{padding:6px 10px;border-radius:6px;border:1px solid #333;background:#161a20;color:#fff}
    button{padding:8px 16px;border:none;border-radius:8px;cursor:pointer;font-family:inherit}
    .connect{background:#00b894;color:#fff}
    .disconnect{background:#d63031;color:#fff}
    .connect:disabled,.disconnect:disabled{opacity:.6;cursor:not-allowed}
    .status{font-weight:bold;margin-left:auto}
  </style>
</head>
<body>
  <h2>üì° WS Monitor</h2>

  <!-- Crypto Section -->
  <div class="section" id="crypto-section">
    <h3>Crypto</h3>
    <div class="controls">
      <input id="crypto-symbol" type="text" value="BTC-USD" placeholder="Enter crypto symbol (e.g. ETH-USD)">
      <button class="connect" id="crypto-connect">Connect</button>
      <button class="disconnect" id="crypto-disconnect" disabled>Disconnect</button>
      <span class="status" id="crypto-status">üîÑ Not connected</span>
    </div>
    <table>
      <thead><tr><th>Symbol</th><th>Price</th><th>Time</th></tr></thead>
      <tbody id="crypto-body"><tr><td colspan="3" style="text-align:center;">Waiting...</td></tr></tbody>
    </table>
    <h4>Last 20 prices</h4>
    <ul class="last-list" id="crypto-history"></ul>
  </div>

  <!-- Forex Section -->
  <div class="section" id="forex-section">
    <h3>Forex</h3>
    <div class="controls">
      <input id="forex-symbol" type="text" value="EURUSD" placeholder="Enter forex symbol (e.g. GBPUSD)">
      <button class="connect" id="forex-connect">Connect</button>
      <button class="disconnect" id="forex-disconnect" disabled>Disconnect</button>
      <span class="status" id="forex-status">üîÑ Not connected</span>
    </div>
    <table>
      <thead><tr><th>Symbol</th><th>Price</th><th>Time</th></tr></thead>
      <tbody id="forex-body"><tr><td colspan="3" style="text-align:center;">Waiting...</td></tr></tbody>
    </table>
    <h4>Last 20 prices</h4>
    <ul class="last-list" id="forex-history"></ul>
  </div>

  <script>
    const fmtTime = () => new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'});

    async function initFeed(type) {
      const urlData = await fetch("/.netlify/functions/ws-proxy").then(r => r.json());
      const baseUrl = urlData.url;
      const wsUrl = baseUrl.replace("/crypto?", type === "forex" ? "/forex?" : "/crypto?");
      const input = document.getElementById(`${type}-symbol`);
      const connectBtn = document.getElementById(`${type}-connect`);
      const disconnectBtn = document.getElementById(`${type}-disconnect`);
      const statusEl = document.getElementById(`${type}-status`);
      const bodyEl = document.getElementById(`${type}-body`);
      const historyEl = document.getElementById(`${type}-history`);

      let ws, lastPrice=null, history=[];

      function renderHistory() {
        historyEl.innerHTML = history.slice().reverse().map(h => 
          `<li class="tick"><span>${h.time}</span><span class="${h.cls}">${h.price.toFixed(4)}</span></li>`
        ).join('');
      }

      function connect() {
        const symbol = input.value.trim().toUpperCase();
        if (!symbol) return alert("Enter symbol first!");
        ws = new WebSocket(wsUrl);
        statusEl.textContent = "‚è≥ Connecting...";
        connectBtn.disabled = true;
        disconnectBtn.disabled = false;
        ws.onopen = () => {
          statusEl.textContent = "‚úÖ Connected";
          ws.send(JSON.stringify({action:"subscribe",symbols:symbol}));
        };
        ws.onmessage = e => {
          const d = JSON.parse(e.data);
          if (!d.s || d.p === undefined) return;
          const price = +d.p;
          const cls = lastPrice ? (price>lastPrice?'up':price<lastPrice?'down':'') : '';
          lastPrice = price;
          bodyEl.innerHTML = `<tr><td>${d.s}</td><td class="${cls}">${price.toFixed(4)}</td><td>${fmtTime()}</td></tr>`;
          history.push({price,cls,time:fmtTime()});
          if (history.length>20) history.shift();
          renderHistory();
        };
        ws.onclose = () => {
          statusEl.textContent = "‚ùå Disconnected";
          connectBtn.disabled = false;
          disconnectBtn.disabled = true;
        };
        ws.onerror = err => {
          console.error(err);
          statusEl.textContent = "‚ö†Ô∏è Error";
        };
      }

      function disconnect() {
        if (ws) ws.close();
        ws = null;
        connectBtn.disabled = false;
        disconnectBtn.disabled = true;
        statusEl.textContent = "üî¥ Disconnected";
      }

      connectBtn.onclick = connect;
      disconnectBtn.onclick = disconnect;
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±–∞ –±–ª–æ–∫–∞
    initFeed("crypto");
    initFeed("forex");
  </script>
</body>
</html>
