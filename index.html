<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>WS Monitor ‚Äî Crypto, Forex & US Stocks Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --bg: #0e1117;
      --panel: #1b1f27;
      --card: #101318;
      --accent: #66fcf1;
      --muted: #222831;
      --text: #e0e0e0;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Courier New', monospace;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: var(--panel);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 12px 20px;
      border-bottom: 1px solid var(--muted);
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }

    header h1 {
      color: var(--accent);
      margin: 0;
      font-size: 20px;
      letter-spacing: 1px;
    }

    main {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 16px;
      padding: 20px;
      flex: 1;
    }

    .section {
      background: var(--panel);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.25);
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .section::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 6px;
      height: 100%;
      background: linear-gradient(180deg, var(--accent), transparent);
      opacity: 0.7;
      border-radius: 12px 0 0 12px;
    }

    .header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .header-row h2 {
      color: var(--accent);
      font-size: 18px;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .header-row h2 span {
      font-size: 14px;
      color: var(--text);
      opacity: 0.8;
      font-weight: normal;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 12px;
      align-items: center;
    }

    input {
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #333;
      background: #161a20;
      color: #fff;
      flex: 1;
      min-width: 120px;
    }

    button {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-family: inherit;
    }
    .connect { background: #00b894; color: #fff; }
    .disconnect { background: #d63031; color: #fff; }
    .connect:disabled, .disconnect:disabled { opacity: .6; cursor: not-allowed; }

    .status {
      font-weight: bold;
      margin-left: auto;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      background: var(--card);
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 10px;
      font-size: 13px;
    }

    th, td {
      padding: 8px;
      text-align: left;
      vertical-align: top;
    }

    th {
      background: var(--muted);
      color: var(--accent);
    }

    tr:nth-child(even) {
      background: #161a20;
    }

    pre {
      margin: 0;
      white-space: pre-wrap;
      word-break: break-all;
    }

    .last-list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 520px;
      overflow-y: auto;
      border: 1px solid #333;
      border-radius: 8px;
      background: #11141c;
      flex: 1;
    }

    .tick {
      padding: 6px 10px;
      border-bottom: 1px dashed #2a2f3a;
      font-size: 13px;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .tick:last-child { border-bottom: none; }
  </style>
</head>
<body>
  <header>
    <h1>üìä WS Monitor ‚Äî Crypto, Forex & US Stocks</h1>
  </header>

  <main>
    <!-- Crypto -->
    <div class="section" id="crypto-section">
      <div class="header-row">
        <h2>üí∞ Crypto <span>(BTC-USD)</span></h2>
        <span class="status" id="crypto-status">üîÑ Not connected</span>
      </div>
      <div class="controls">
        <input id="crypto-symbol" type="text" value="BTC-USD" placeholder="Symbol (e.g. ETH-USD)">
        <button class="connect" id="crypto-connect">Connect</button>
        <button class="disconnect" id="crypto-disconnect" disabled>Disconnect</button>
      </div>
      <table>
        <thead><tr><th>Raw Message</th><th>Time</th></tr></thead>
        <tbody id="crypto-body"><tr><td colspan="2" style="text-align:center;">Waiting...</td></tr></tbody>
      </table>
      <h4>Last 20 messages</h4>
      <ul class="last-list" id="crypto-history"></ul>
    </div>

    <!-- Forex -->
    <div class="section" id="forex-section">
      <div class="header-row">
        <h2>üí± Forex <span>(EURUSD)</span></h2>
        <span class="status" id="forex-status">üîÑ Not connected</span>
      </div>
      <div class="controls">
        <input id="forex-symbol" type="text" value="EURUSD" placeholder="Symbol (e.g. GBPUSD)">
        <button class="connect" id="forex-connect">Connect</button>
        <button class="disconnect" id="forex-disconnect" disabled>Disconnect</button>
      </div>
      <table>
        <thead><tr><th>Raw Message</th><th>Time</th></tr></thead>
        <tbody id="forex-body"><tr><td colspan="2" style="text-align:center;">Waiting...</td></tr></tbody>
      </table>
      <h4>Last 20 messages</h4>
      <ul class="last-list" id="forex-history"></ul>
    </div>

    <!-- US Stocks -->
    <div class="section" id="us-section">
      <div class="header-row">
        <h2>üèõÔ∏è US Tickers <span>(AAPL)</span></h2>
        <span class="status" id="us-status">üîÑ Not connected</span>
      </div>
      <div class="controls">
        <input id="us-symbol" type="text" value="AAPL" placeholder="Symbol (e.g. TSLA)">
        <button class="connect" id="us-connect">Connect</button>
        <button class="disconnect" id="us-disconnect" disabled>Disconnect</button>
      </div>
      <table>
        <thead><tr><th>Raw Message</th><th>Time</th></tr></thead>
        <tbody id="us-body"><tr><td colspan="2" style="text-align:center;">Waiting...</td></tr></tbody>
      </table>
      <h4>Last 20 messages</h4>
      <ul class="last-list" id="us-history"></ul>
    </div>
  </main>

  <script>
    const fmtTime = () => new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'});

    async function initFeed(type) {
      const urlData = await fetch("/api/ws-proxy").then(r => r.json());
      const baseUrl = urlData.url;
      let wsUrl = baseUrl;

      // –≤—ã–±–∏—Ä–∞–µ–º —Ç–∏–ø –ø–æ—Ç–æ–∫–∞
      if (type === "forex") wsUrl = baseUrl.replace("/crypto?", "/forex?");
      if (type === "us") wsUrl = baseUrl.replace("/crypto?", "/us?");

      const input = document.getElementById(`${type}-symbol`);
      const connectBtn = document.getElementById(`${type}-connect`);
      const disconnectBtn = document.getElementById(`${type}-disconnect`);
      const statusEl = document.getElementById(`${type}-status`);
      const bodyEl = document.getElementById(`${type}-body`);
      const historyEl = document.getElementById(`${type}-history`);

      let ws = null, history = [];

      function renderHistory() {
        historyEl.innerHTML = history.slice().reverse().map(h =>
          `<li class="tick">${h.time} ‚Äî ${h.msg}</li>`
        ).join('');
      }

      function connect() {
        const symbol = input.value.trim().toUpperCase();
        if (!symbol) return alert("Enter symbol first!");
        ws = new WebSocket(wsUrl);
        statusEl.textContent = "‚è≥ Connecting...";
        connectBtn.disabled = true;
        disconnectBtn.disabled = false;
        ws.onopen = () => {
          statusEl.textContent = "‚úÖ Connected";
          ws.send(JSON.stringify({action:"subscribe",symbols:symbol}));
        };
        ws.onmessage = e => {
          const msg = e.data;
          const time = fmtTime();
          bodyEl.innerHTML = `<tr><td><pre>${msg}</pre></td><td>${time}</td></tr>`;
          history.push({msg, time});
          if (history.length > 20) history.shift();
          renderHistory();
        };
        ws.onclose = () => {
          statusEl.textContent = "‚ùå Disconnected";
          connectBtn.disabled = false;
          disconnectBtn.disabled = true;
        };
        ws.onerror = err => {
          console.error(err);
          statusEl.textContent = "‚ö†Ô∏è Error";
        };
      }

      function disconnect() {
        if (ws) ws.close();
        ws = null;
        connectBtn.disabled = false;
        disconnectBtn.disabled = true;
        statusEl.textContent = "üî¥ Disconnected";
      }

      connectBtn.onclick = connect;
      disconnectBtn.onclick = disconnect;
    }

    initFeed("crypto");
    initFeed("forex");
    initFeed("us");
  </script>
</body>
</html>
